[TOC]



# 线上问题记录

## 常规问题

### 问题：长时间停顿、接口超时、线程内逻辑不执行以及CPU占用率过高等线程问题

使用：jstack命令结合线程状态使用。生成JVM当前的线程的快照

#### 线程状态

![image-20230510151445888](assets/image-20230510151445888.png)

1. 使用jps、ps -ef | grep java查看当前java进程的pid，严重情况下可以使用top命令查看当前系统cpu/内存使用率最高的进程pid。

![image-20230510150428951](assets/image-20230510150428951.png)

这里我们的死锁的pid是：3429，这里程序很简单，虽然程序死锁，没有占用很多资源。

2. 使用top -Hp 3429命令查看进程里面占用最多的资源的线程。

![image-20230510150449372](assets/image-20230510150449372.png)

这里我们看到的占用最多资源的线程是：3440。

3. 使用命令printf "%x\n" 3440 把线程pid转换成16进制数，得到：d70。

4. 使用jstack 3429 | grep -20 d70命令查询该线程阻塞的地方。

![image-20230510150529961](assets/image-20230510150529961.png)

到这里就基本跟踪完毕，去代码所在行看看为什么死锁吧。

#### 真正的线上问题的场景

1. 我们man端任务偶发性任务不行，偶尔执行，偶尔不执行
2. 机器假死（不处理Http请求），但是进程依然存活

#### 小结

1. jps、ps -ef | grep java查看当前java进程的pid
2. 使用top -Hp XXX命令查看进程里面占用最多的资源的线程。
3. 使用命令printf "%x\n" 3440 把线程pid转换成16进制数
4. 使用jstack 3429 | grep -20 d70命令查询该线程或者使用stack

### 问题：内存溢出

使用MAT等堆内存分析工具处理即可

### 问题：事务失效问题

问题：线上事务内的两条数据不一致

前置知识：todo Spring事务源码详解

结论：Mybatis的SqlSessionFactory中的dataSource要和Spring的DataSourceTransactionManager中的dataSource是一个引用，否则导致事务不生效，因为是使用Threadlocal上是根据dataSource来获取相同的connect来保证使用的是一个数据库连接来保证事务的特性。

### 问题：Mysql：偶发性通信链路故障的问题

问题：偶发性通信链路故障

背景：内网环境下，不涉及NAT以及路由器，请求Mysql集群

前置知识：Mysql的JDBC以及Druid的连接池 todo详见，Mysql集群的模型

![image-20230517184436811](assets/image-20230517184436811.png)

分析过程：

首先确保本app的数据库连接的保活机制没有问题，但是由于mysql集群存在负载均衡，而负载均衡存在保活机制（固定时间剔除没有请求的连接）可能剔除连接

结论：最终定位到负载均衡剔除连接的问题

### 问题：canal：ES与数据库数据不一致

背景：ES与数据库数据不一致导致订单状态暂停，利用数据库+canal+mq+应用代码处理同步到ES，其中canal同步数据见todoCanal数据同步

![image-20230517211752351](assets/image-20230517211752351.png)

问题原因：断网演练导致canal假死

解决方案：canal假死但是offset依赖存在，mysql的binlog也没有清理，设置下offset重新同步即可

展望：目前canal支持直接把数据同步到ES等

### 问题：Redis：产生大量无效的key

背景：大促压测导致压进去大量无效的key，影响线上Redis的稳定以及下一次压测。

前置知识：SCAN 命令是一个基于游标的迭代器，每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为 SCAN 命令的游标参数， 以此来延续之前的迭代过程。

解决方案：使用SCAN命令在不阻塞redis的情况下清楚所有的无效的Key

### 问题：MQ：消息没有手动确认

背景：几乎所有的mq都会有持久化（kafka的0.11之后可以通过配置来保证CP，来实现消息不丢失）来保存消费过的消息

解决方案：可以联系消息管理员进行offset重置，但是有个前提mq的消费逻辑要保证幂等（通常mq要保证最少一次消费，所以基本都保证了幂等）



## 非常规问题

### 问题：流量较大造成mq大量积压

![image-20230517205037500](assets/image-20230517205037500.png)

### 问题：运行中的机器有的rpc接口正常有的抛异常（java.lang.NoClassDefFoundError）

#### NoClassDefFoundError和ClassNotFoundException区别

1. NoClassDefFoundError发生在JVM在动态运行时，根据你提供的类名，在classpath中找到对应的类进行加载，但当它找不到这个类时，就发生了java.lang.NoClassDefFoundError的错误
2. ClassNotFoundException是在编译的时候在classpath中找不到对应的类而发生的错误。





### 问题：部分接口性能差，导致机器整体性能变差





































## 参考

https://mp.weixin.qq.com/s/nRTBJKzgaGqR_M3JYwXyyQ